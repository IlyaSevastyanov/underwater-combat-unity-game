using System.Collections;
using UnityEngine;

public class SubmarineInvulnerabilityBlink : MonoBehaviour
{
    [Header("Что будет мигать (модель субмарины)")]
    public Renderer[] renderers;              // MeshRenderer / SkinnedMeshRenderer

    [Header("Параметры инвулна")]
    [Tooltip("Сколько секунд сабмарина мигает и считается неуязвимой для рыбы")]
    public float invulnDuration = 2f;

    [Tooltip("Как часто мигать (сек)")]
    public float blinkInterval = 0.15f;

    [Tooltip("Начать с видимой фазы или с невидимой")]
    public bool startVisible = true;

    bool isInvulnerable;
    Coroutine blinkRoutine;

    // Геттер, чтобы другие скрипты могли узнать, есть ли инвулн
    public bool IsInvulnerable => isInvulnerable;

    void Awake()
    {
        // Если рендеры не заданы — попробуем сами
        if (renderers == null || renderers.Length == 0)
            renderers = GetComponentsInChildren<Renderer>();

        SetRenderersVisible(true);
    }

    public void TriggerInvulnerability()
    {
        if (blinkRoutine != null)
            StopCoroutine(blinkRoutine);

        blinkRoutine = StartCoroutine(BlinkCoroutine());
    }

    IEnumerator BlinkCoroutine()
    {
        isInvulnerable = true;

        float timer = 0f;
        bool visible = startVisible;

        while (timer < invulnDuration)
        {
            SetRenderersVisible(visible);
            visible = !visible;

            yield return new WaitForSeconds(blinkInterval);
            timer += blinkInterval;
        }

        // В конце инвулна: всегда видимая лодка
        SetRenderersVisible(true);

        isInvulnerable = false;
        blinkRoutine = null;
    }

    void SetRenderersVisible(bool visible)
    {
        if (renderers == null) return;

        foreach (var r in renderers)
        {
            if (r != null)
                r.enabled = visible;
        }
    }
}
